name: Release

on:
  push:
    branches: [main]
    paths:
      - 'custom_components/whatsapp/manifest.json'
  schedule:
    - cron: '0 0 * * 6' # Weekly on Saturday Midnight
  workflow_dispatch:
    inputs:
      help:
        description: |
          ‚ÑπÔ∏è QUICK HELP - HOW VERSIONING WORKS:
          --------------------------------------
          The version is ALWAYS calculated from the ABSOLUTE LATEST tag.
          (Including Betas/Nightlies).

          TARGET       | TYPE   | BUMP  | RESULT
          -------------|--------|-------|-------
          Next Beta    | Beta   | none  | 1.1.0b0 -> 1.1.0b1
          New Stable   | Stable | none  | 1.1.0b0 -> 1.1.0
          New Patch    | Stable | patch | 1.1.0 -> 1.1.1
          New Minor    | Stable | minor | 1.1.1 -> 1.2.0

          1. RELEASE TYPE:
             ‚Ä¢ Stable: Tags X.Y.Z.
             ‚Ä¢ Beta: Tags X.Y.ZbN (Increments N automatically).

          2. AUTO-BUMP TYPE:
             ‚Ä¢ Applied to the latest tag (e.g. 1.1.0b0).
             ‚Ä¢ 'none' means: Keep the same Major.Minor.Patch series.
        required: false
        type: boolean
        default: true
      release_type:
        description: 'Which type of release to create?'
        required: true
        default: 'beta'
        type: choice
        options:
        - beta
        - stable
        - nightly
        - addon_sync
        - manual
      bump_type:
        description: 'How should the version be incremented from the last tag?'
        required: true
        default: 'none'
        type: choice
        options:
        - none
        - patch
        - minor
        - major
      manual_version:
        description: 'Manual Version (only for Manual release type, e.g. 1.2.3b5)'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: Determine Release Parameters
        id: params
        run: |
          RELEASE_TYPE="${{ inputs.release_type || 'auto' }}"
          BUMP_TYPE="${{ inputs.bump_type || 'patch' }}"

          # If triggered by schedule, force nightly (pre-release)
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            RELEASE_TYPE="nightly"
            echo "üìÖ Scheduled run: Forcing release type to nightly"
          fi

          # Get BASE_VERSION from the absolute latest tag (including betas)
          LATEST_TAG=$(git tag -l "v[0-9]*" --sort=-v:refname | head -n 1)

          if [[ -z "$LATEST_TAG" ]]; then
            # No tags exist at all, start from 1.0.0
            BASE_VERSION="1.0.0"
            echo "‚ÑπÔ∏è No tags found, starting from $BASE_VERSION"
          else
            # Strip 'v' and everything after b or .dev to get the core X.Y.Z
            CLEAN_VERSION="${LATEST_TAG#v}"
            CLEAN_VERSION="${CLEAN_VERSION%%b*}"
            CLEAN_VERSION="${CLEAN_VERSION%%.dev*}"
            BASE_VERSION="$CLEAN_VERSION"
            echo "‚ÑπÔ∏è Derived BASE_VERSION from latest tag: $LATEST_TAG -> $BASE_VERSION"
          fi

          # Handle manual bump override from workflow_dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
             IFS='.' read -r major minor patch <<< "$BASE_VERSION"
             if [[ "$BUMP_TYPE" == "minor" ]]; then
                 BASE_VERSION="${major}.$((minor + 1)).0"
                 echo "‚ÑπÔ∏è Manual Minor Bump: Adjusted Base Version to $BASE_VERSION"
             elif [[ "$BUMP_TYPE" == "major" ]]; then
                 BASE_VERSION="$((major + 1)).0.0"
                 echo "‚ÑπÔ∏è Manual Major Bump: Adjusted Base Version to $BASE_VERSION"
             elif [[ "$BUMP_TYPE" == "patch" ]]; then
                 BASE_VERSION="${major}.${minor}.$((patch + 1))"
                 echo "‚ÑπÔ∏è Manual Patch Bump: Adjusted Base Version to $BASE_VERSION"
             else
                 echo "‚ÑπÔ∏è No bump requested (none): Staying on $BASE_VERSION"
             fi
          fi

          VERSION="$BASE_VERSION"
          SHOULD_RELEASE="false"
          PRERELEASE="false"

          echo "Base Version (after bump check): $BASE_VERSION"
          echo "Release Type: $RELEASE_TYPE"

          if [[ "$RELEASE_TYPE" == "auto" ]]; then
            # Auto mode is triggered by manifest.json push - check if we should release
            MANIFEST_VERSION=$(jq -r '.version' custom_components/whatsapp/manifest.json)
            if [[ "$MANIFEST_VERSION" != *"-dev"* ]] && [[ "$MANIFEST_VERSION" != *"b"* ]]; then
              # Manifest has a stable version, release it
              VERSION="$MANIFEST_VERSION"
              SHOULD_RELEASE="true"
              PRERELEASE="false"
            elif [[ "$MANIFEST_VERSION" == *"b"* ]]; then
              VERSION="$MANIFEST_VERSION"
              SHOULD_RELEASE="true"
              PRERELEASE="true"
            else
              echo "Auto mode: Skipping release for dev version $MANIFEST_VERSION"
            fi

          elif [[ "$RELEASE_TYPE" == "stable" ]]; then
            # Parse Major.Minor from Base Version
            IFS='.' read -r major minor patch <<< "$BASE_VERSION"

            # Find highest existing STABLE tag for this Major.Minor version (exclude betas/devs)
            HIGHEST_TAG=$(git tag -l "v${major}.${minor}.*" --sort=-v:refname | grep -vE 'b[0-9]+|\.dev' | head -n 1)

            if [[ -n "$HIGHEST_TAG" ]]; then
              # Extract patch from highest tag (v1.0.1 -> 1)
              HIGHEST_VERSION=${HIGHEST_TAG#v}
              IFS='.' read -r h_major h_minor h_patch <<< "$HIGHEST_VERSION"

              # If existing tag is >= manifest version, we simply increment the highest found patch
              if (( h_patch >= patch )); then
                 NEW_PATCH=$((h_patch + 1))
                 VERSION="${major}.${minor}.${NEW_PATCH}"
                 echo "‚ÑπÔ∏è Existing tag v$BASE_VERSION (or higher) found. Auto-incrementing to $VERSION"
              else
                 # Manifest is already higher (e.g. 1.0.2 vs 1.0.1)
                 VERSION="$BASE_VERSION"
              fi
            else
              # No existing tags for this minor version
              VERSION="$BASE_VERSION"
            fi

            SHOULD_RELEASE="true"
            PRERELEASE="false"

          elif [[ "$RELEASE_TYPE" == "beta" ]]; then
             # Always look for the next logical beta tag for the calculated BASE_VERSION
             LAST_BETA=$(git tag -l "v${BASE_VERSION}b*" --sort=-v:refname | head -n 1)

             if [[ -z "$LAST_BETA" ]]; then
                 # No beta exists for this base, start at b0
                 VERSION="${BASE_VERSION}b0"
             else
                 # Increment last beta (e.g. v1.0.1b0 -> 1.0.1b1)
                 B_NUM=$(echo "$LAST_BETA" | sed 's/.*b//')
                 VERSION="${BASE_VERSION}b$((B_NUM + 1))"
             fi

             SHOULD_RELEASE="true"
             PRERELEASE="true"

          elif [[ "$RELEASE_TYPE" == "nightly" ]]; then
            # Nightly releases should follow the pattern: X.Y.Z.dev<date>
            DATE_TAG=$(date +'%Y%m%d')
            VERSION="${BASE_VERSION}.dev${DATE_TAG}"
            SHOULD_RELEASE="true"
            PRERELEASE="true"

          elif [[ "$RELEASE_TYPE" == "manual" ]]; then
            if [[ -z "${{ inputs.manual_version }}" ]]; then
              echo "Error: Manual version is required for 'manual' release type"
              exit 1
            fi
            VERSION="${{ inputs.manual_version }}"
            SHOULD_RELEASE="true"
            PRERELEASE="false"
            if [[ "$VERSION" == *"b"* ]] || [[ "$VERSION" == *"dev"* ]] || [[ "$VERSION" == *"nightly"* ]]; then
              PRERELEASE="true"
            fi
          elif [[ "$RELEASE_TYPE" == "addon_sync" ]]; then
            echo "üîÑ Syncing version from Addon repository..."
            ADDON_CONFIG_URL="https://raw.githubusercontent.com/FaserF/hassio-addons/master/whatsapp/config.yaml"

            # Fetch config and extract version
            REMOTE_VERSION=$(curl -s "$ADDON_CONFIG_URL" | grep "^version:" | head -n 1 | awk '{print $2}' | tr -d '"' | tr -d "'")

            if [[ -z "$REMOTE_VERSION" ]]; then
               echo "‚ùå Failed to fetch version from addon config!"
               exit 1
            fi

            VERSION="$REMOTE_VERSION"
            SHOULD_RELEASE="true"
            PRERELEASE="false" # Sync implies stable release
            echo "‚úÖ Fetched version: $VERSION"
          fi

          echo "Final Version: $VERSION"

          # Check if tag already exists to prevent accidental overwrites
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag v$VERSION already exists."
            if [[ "$RELEASE_TYPE" != "manual" ]]; then
               echo "‚õî $RELEASE_TYPE mode: Aborting release to avoid overwriting existing tag."
               SHOULD_RELEASE="false"
            else
               echo "‚ö†Ô∏è Manual mode: Proceeding (will update existing tag)."
            fi
          fi

          echo "Should Release: $SHOULD_RELEASE"
          echo "Prerelease: $PRERELEASE"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Prepare Release Version (Update Manifest)
        if: steps.params.outputs.should_release == 'true'
        run: |
            MANIFEST_VERSION=$(jq -r '.version' custom_components/whatsapp/manifest.json)
            TARGET_VERSION="${{ steps.params.outputs.version }}"

            if [[ "$MANIFEST_VERSION" != "$TARGET_VERSION" ]]; then
              echo "Updating manifest version from $MANIFEST_VERSION to $TARGET_VERSION..."
              jq --arg v "$TARGET_VERSION" '.version = $v' custom_components/whatsapp/manifest.json > tmp.json
              mv tmp.json custom_components/whatsapp/manifest.json

              # Commit the change so the release tag points to a commit with the correct version
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add custom_components/whatsapp/manifest.json
              git commit -m "chore: release version $TARGET_VERSION"
              git push
              echo "NEW_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
            else
              echo "Manifest version already correct: $MANIFEST_VERSION"
              echo "NEW_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
            fi

      - name: Create release archive
        if: steps.params.outputs.should_release == 'true'
        run: |
          cd custom_components
          zip -r ../whatsapp.zip whatsapp

      - name: üìù Determine Base Tag for Changelog
        if: steps.params.outputs.should_release == 'true'
        id: base_tag
        run: |
          RELEASE_TYPE="${{ steps.params.outputs.release_type }}"

          if [[ "${{ steps.params.outputs.prerelease }}" == "false" ]]; then
            # Releasing STABLE: Compare against the last tag that matches v*.*.* (excluding betas/devs)
            LAST_STABLE=$(git tag -l "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | grep -vE "b[0-9]|\.dev[0-9]" | head -n 1)
            echo "base_tag=$LAST_STABLE" >> $GITHUB_OUTPUT
            echo "üîç Comparing stable release against last stable: $LAST_STABLE"
          else
            # Releasing BETA/NIGHTLY: Compare against the absolute last tag
            LAST_TAG=$(git tag --sort=-v:refname | head -n 1)
            echo "base_tag=$LAST_TAG" >> $GITHUB_OUTPUT
            echo "üîç Comparing prerelease against last tag: $LAST_TAG"
          fi

          if [[ -z "$LAST_STABLE" ]] && [[ -z "$LAST_TAG" ]]; then
             echo "‚ö†Ô∏è No previous tags found. Changelog will cover all commits."
          fi

      - name: üìù Build Changelog
        if: steps.params.outputs.should_release == 'true'
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v6
        with:
          configuration: ".github/release-changelog-config.json"
          fromTag: ${{ steps.base_tag.outputs.base_tag }}
          toTag: HEAD
          mode: "HYBRID"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        if: steps.params.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.params.outputs.version }}
          name: v${{ steps.params.outputs.version }}
          body: ${{ steps.build_changelog.outputs.changelog }}
          prerelease: ${{ steps.params.outputs.prerelease }}
          files: whatsapp.zip
          target_commitish: ${{ env.NEW_SHA }}

      - name: Bump to next dev version
        # Run dev bump for auto, stable, and beta to prevent re-release issues.
        if: steps.params.outputs.should_release == 'true' && (steps.params.outputs.release_type == 'auto' || steps.params.outputs.release_type == 'stable' || steps.params.outputs.release_type == 'beta')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase
          VERSION=$(jq -r '.version' custom_components/whatsapp/manifest.json)
          BUMP_TYPE="${{ steps.params.outputs.bump_type }}"

          # Clean version
          CLEAN_VERSION="${VERSION%%b*}"
          CLEAN_VERSION="${CLEAN_VERSION%%.dev*}"
          CLEAN_VERSION="${CLEAN_VERSION%%-*}"

          # Parse major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CLEAN_VERSION"

          # For beta releases, just increment patch (e.g., 1.1.0b0 -> 1.1.1-dev)
          # For stable/auto releases, respect BUMP_TYPE.
          if [[ "${{ steps.params.outputs.release_type }}" == "beta" ]]; then
            NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))-dev"
          elif [[ "$BUMP_TYPE" == "major" ]]; then
            NEXT_VERSION="$((MAJOR + 1)).0.0-dev"
          elif [[ "$BUMP_TYPE" == "minor" ]]; then
            NEXT_VERSION="${MAJOR}.$((MINOR + 1)).0-dev"
          else
            NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))-dev"
          fi

          echo "Bumping version from $VERSION to $NEXT_VERSION ($BUMP_TYPE)"

          # Update manifest.json
          jq --arg v "$NEXT_VERSION" '.version = $v' custom_components/whatsapp/manifest.json > tmp.json
          mv tmp.json custom_components/whatsapp/manifest.json
          # Commit and push
          git add custom_components/whatsapp/manifest.json
          git commit -m "chore: bump to dev version $NEXT_VERSION [skip ci]"
          git push
